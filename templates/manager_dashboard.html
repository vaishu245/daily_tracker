<!DOCTYPE html>
<html>
<head>
<title>Manager Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

body {
    margin:0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    font-family: "Segoe UI";
}

/* MAIN CONTAINER */
.container {
    width:95%;
    max-width:1200px;
    margin:40px auto;
    background:white;
    padding:30px;
    border-radius:20px;
    box-shadow:0 20px 40px rgba(0,0,0,0.2);
}

/* HEADER */
.header-box {
    background:#fff;
    padding:15px 20px;
    border-radius:12px;
    margin-bottom:25px;
    box-shadow:0 8px 16px rgba(0,0,0,0.08);
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:12px;
}

.header-actions {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}

.header-link {
    padding:8px 14px;
    border-radius:20px;
    font-weight:600;
    text-decoration:none;
    color:white;
    font-size:14px;
}

.reset { background:#ff5252; }
.leave { background:#ff9800; }
.ok { background:#4caf50; }

h2 {
    text-align:center;
    margin:25px 0 15px;
}

/* FILTER BAR */
.filter-bar {
    display:flex;
    justify-content:center;
    gap:15px;
    flex-wrap:wrap;
    background:#f4f6ff;
    padding:15px;
    border-radius:14px;
    margin-bottom:30px;
    border:2px solid #4b49ac;
}

.filter-bar label {
    font-size:13px;
    font-weight:600;
    color:#444;
}

.filter-bar select,
.filter-bar button {
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #bbb;
    font-size:14px;
}

.filter-bar button {
    background:#4b49ac;
    color:white;
    border:none;
    cursor:pointer;
    font-weight:600;
}

/* KPI CARDS */
.kpi-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:20px;
    margin-bottom:35px;
}

.kpi {
    background: linear-gradient(135deg, #4b49ac, #6a67ce);
    padding:24px;
    border-radius:18px;
    text-align:center;
    color:white;
    box-shadow:0 15px 25px rgba(0,0,0,0.2);
    transition:0.3s ease;
}

.kpi:hover {
    transform:translateY(-5px);
}

.kpi h4 {
    margin:0;
    font-size:14px;
    opacity:0.9;
}

.kpi p {
    margin-top:12px;
    font-size:26px;
    font-weight:bold;
}

/* CHART CARD */
.chart-card {
    background:white;
    padding:25px;
    border-radius:20px;
    box-shadow:0 15px 30px rgba(0,0,0,0.15);
    margin-bottom:35px;
    display:flex;
    justify-content:center;
}

/* RESPONSIVE CHART CONTAINER */
.chart-wrapper {
    width:100%;
    max-width:250px;
    aspect-ratio:1/1;
}

/* TABLE */
.table-wrapper {
    overflow-x:auto;
}

table {
    width:100%;
    border-collapse:collapse;
    min-width:750px;
}

th, td {
    padding:12px;
    border:1px solid #ccc;
    text-align:center;
}

th {
    background:#4b49ac;
    color:white;
}

tr:hover {
    background:#f1f1ff;
}

a {
    color:#4b49ac;
    text-decoration:none;
    font-weight:bold;
}

/* ACTION BUTTONS */
.actions {
    display:flex;
    justify-content:space-between;
    margin-top:30px;
    flex-wrap:wrap;
    gap:15px;
}

button {
    padding:12px 25px;
    border-radius:25px;
    border:none;
    cursor:pointer;
    color:white;
    font-weight:600;
}

.btn-back { background:#999; }
.btn-pdf { background:#ff5c5c; }

/* ----------- MOBILE OPTIMIZATION ----------- */
@media (max-width:768px){

    .container {
        padding:20px;
    }

    .header-box {
        flex-direction:column;
        align-items:flex-start;
    }

    .kpi-grid {
        grid-template-columns:1fr;
    }

    .chart-wrapper {
        max-width:300px;
    }

    .actions {
        flex-direction:column;
        align-items:center;
    }

    button {
        width:100%;
        max-width:300px;
    }
}

/* ----------- TABLET OPTIMIZATION ----------- */
@media (min-width:769px) and (max-width:1024px){

    .chart-wrapper {
        max-width:340px;
    }

    .kpi-grid {
        grid-template-columns:repeat(2,1fr);
    }
}

</style>
</head>

<body>

<div class="container" id="manager-report">

<div class="header-box">
    <h3 style="margin:0;">Manager Dashboard</h3>

    <div class="header-actions">

        {% if pending_count > 0 %}
            <a href="/manager/reset-requests" class="header-link reset">
                üîê Reset Requests ({{ pending_count }})
            </a>
        {% else %}
            <span class="header-link ok">
                ‚úÖ No Reset Requests
            </span>
        {% endif %}

        {% if leave_pending_count > 0 %}
            <a href="/manager/leave-requests" class="header-link leave">
                üèñ Leave Requests ({{ leave_pending_count }})
            </a>
        {% else %}
            <span class="header-link ok">
                ‚úÖ No Leave Requests
            </span>
        {% endif %}

    </div>
</div>

<h2>üìä Monthly Team Productivity</h2>

<form method="GET" class="filter-bar">
    <label>
        Month<br>
        <select name="month">
            {% for m in range(1,13) %}
            <option value="{{ '%02d' % m }}"
                {% if selected_month == '%02d' % m %}selected{% endif %}>
                {{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1] }}
            </option>
            {% endfor %}
        </select>
    </label>

    <label>
        Year<br>
        <select name="year">
            {% for y in years %}
            <option value="{{ y }}" {% if selected_year == y|string %}selected{% endif %}>
                {{ y }}
            </option>
            {% endfor %}
        </select>
    </label>

    <button type="submit">Apply</button>
</form>

<div class="kpi-grid">
    <div class="kpi">
        <h4>Total Employees</h4>
        <p>{{ data|length }}</p>
    </div>

    <div class="kpi">
        <h4>Avg Productive Hours</h4>
        <p>{{ (data | map(attribute='productive') | sum / (data|length or 1)) | round(1) }}</p>
    </div>

    <div class="kpi">
        <h4>Avg Ideal Hours</h4>
        <p>{{ (data | map(attribute='ideal') | sum / (data|length or 1)) | round(1) }}</p>
    </div>

    <div class="kpi">
        <h4>Total Approved Leaves</h4>
        <p>{{ data | map(attribute='leave_days') | sum }}</p>
    </div>

    <div class="kpi">
        <h4>Overall Productivity %</h4>
        <p>{{ overall_productivity }}%</p>
    </div>
</div>

<h2>üìà Productivity vs Idle</h2>

<div class="chart-card">
    <div class="chart-wrapper">
        <canvas id="prodChart"></canvas>
    </div>
</div>

<div class="table-wrapper">
<table>
<tr>
    <th>Name</th>
    <th>Productive Hrs</th>
    <th>Working Days</th>
    <th>Available Hrs</th>
    <th>Ideal Hrs</th>
    <th>Productivity %</th>
    <th>Leaves Taken</th>
</tr>

{% for e in data %}
<tr>
    <td>
        <a href="/manager/employee/{{ e.name }}?month={{ selected_month }}&year={{ selected_year }}">
            {{ e.name }}
        </a>
    </td>
    <td>{{ e.productive }}</td>
    <td>{{ e.days }}</td>
    <td>{{ e.available }}</td>
    <td>{{ e.ideal }}</td>
    <td>{{ e.productivity }}%</td>
    <td>{{ e.leave_days }}</td>
</tr>
{% endfor %}
</table>
</div>

<div class="actions">
    <form action="/manager">
        <button class="btn-back">‚¨Ö Back</button>
    </form>
    <button class="btn-pdf" onclick="exportPDF()">üìÑ Download PDF</button>
</div>

</div>

/*
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
*/

<script>
Chart.register(ChartDataLabels);

/* ---------------- CHART ---------------- */

const prodPercent = {{ overall_productivity }};
const idlePercent = (100 - prodPercent).toFixed(1);


new Chart(document.getElementById("prodChart"), {
    type: "doughnut",
    data: {
        labels: ["Productive %", "Idle %"],
        datasets: [{
            data: [prodPercent, idlePercent],
            backgroundColor: ["#4caf50", "#ff5252"],
            hoverOffset: 15
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "65%",
        plugins: {
            legend: {
                position: "bottom",
                labels: {
                    font: { size: 14, weight: "bold" }
                }
            },
            datalabels: {
                color: "#fff",
                font: {
                    weight: "bold",
                    size: 16
                },
                formatter: function(value) {
                    return value + "%";
                }
            }
        }
    }
});

/* ---------------- PDF EXPORT ---------------- */

async function exportPDF() {

    const { jsPDF } = window.jspdf;
    const content = document.getElementById("manager-report");

    const canvas = await html2canvas(content, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const width = pdf.internal.pageSize.getWidth();
    const height = canvas.height * width / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, width, height);

    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun",
                        "Jul","Aug","Sep","Oct","Nov","Dec"];

    const selectedMonth = "{{ selected_month }}";
    const selectedYear = "{{ selected_year }}";

    const monthIndex = parseInt(selectedMonth) - 1;
    const monthName = monthNames[monthIndex] || "Report";

    const fileName = `Team_Productivity_Report_${monthName}_${selectedYear}.pdf`;

    pdf.save(fileName);
}
</script>


</body>
</html>
